#!/bin/bash

# Script para mostrar el estado del sistema CLI Universal LLMs en Termux

# Detectar la ubicaciÃ³n del script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ "$SCRIPT_DIR" == *"/bin" ]]; then
    PROJECT_DIR="$HOME/cli-universal-llms"
else
    PROJECT_DIR="$SCRIPT_DIR"
fi

cd "$PROJECT_DIR" 2>/dev/null || {
    echo "âŒ Error: No se encontrÃ³ el proyecto CLI Universal LLMs"
    exit 1
}

echo "ðŸ” Estado del Sistema CLI Universal LLMs"
echo "========================================"
echo ""

# Verificar Python
echo "ðŸ Python:"
if command -v python3 >/dev/null 2>&1; then
    python_version=$(python3 --version 2>&1)
    echo "   âœ… $python_version"
elif command -v python >/dev/null 2>&1; then
    python_version=$(python --version 2>&1)
    echo "   âœ… $python_version"
else
    echo "   âŒ Python no encontrado"
fi

echo ""

# Verificar dependencias crÃ­ticas
echo "ðŸ“¦ Dependencias crÃ­ticas:"
deps=("requests" "click" "rich" "flask" "PIL" "dotenv")
for dep in "${deps[@]}"; do
    if python3 -c "import $dep" 2>/dev/null; then
        echo "   âœ… $dep"
    else
        echo "   âŒ $dep (faltante)"
    fi
done

echo ""

# Verificar PyMuPDF (opcional)
echo "ðŸ“„ Dependencias opcionales:"
if python3 -c "import fitz" 2>/dev/null; then
    echo "   âœ… PyMuPDF (anÃ¡lisis de PDF disponible)"
else
    echo "   âš ï¸  PyMuPDF (anÃ¡lisis de PDF limitado)"
    echo "      Instala con: pip install PyMuPDF"
fi

echo ""

# Verificar archivos del proyecto
echo "ðŸ“ Archivos del proyecto:"
files=("blackbox_cli.py" "app.py" "config.py" "utils.py" "termux_utils.py")
for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        echo "   âœ… $file"
    else
        echo "   âŒ $file (faltante)"
    fi
done

echo ""

# Verificar configuraciÃ³n
echo "ðŸ”§ ConfiguraciÃ³n:"
if [ -f ".env" ]; then
    echo "   âœ… Archivo .env encontrado"
    # Contar claves configuradas (sin mostrar valores)
    configured_keys=$(grep -c "^[A-Z_]*API_KEY=" .env 2>/dev/null || echo "0")
    echo "   ðŸ“Š $configured_keys claves API configuradas"
else
    echo "   âš ï¸  Archivo .env no encontrado"
    echo "      Ejecuta: llm-cli configure"
fi

echo ""

# Verificar historial
echo "ðŸ“š Historial:"
if [ -f "chat_history.json" ]; then
    conversations=$(python3 -c "
import json
try:
    with open('chat_history.json', 'r') as f:
        data = json.load(f)
    print(len(data))
except:
    print('0')
" 2>/dev/null)
    echo "   ðŸ“Š $conversations conversaciones guardadas"
else
    echo "   ðŸ“Š Sin historial (archivo nuevo)"
fi

echo ""

# Mostrar informaciÃ³n especÃ­fica de Termux si estÃ¡ disponible
if python3 -c "from termux_utils import is_termux; exit(0 if is_termux() else 1)" 2>/dev/null; then
    echo "ðŸ“± Estado especÃ­fico de Termux:"
    python3 -c "
from termux_utils import print_termux_status
print_termux_status()
"
else
    echo "ðŸ“± Utilidades de Termux no disponibles"
fi

echo ""
echo "ðŸš€ Para empezar a usar:"
echo "   1. llm-cli configure    (configurar API keys)"
echo "   2. llm-cli chat 'hola'  (probar funcionamiento)"
echo "   3. llm-web              (interfaz web)"