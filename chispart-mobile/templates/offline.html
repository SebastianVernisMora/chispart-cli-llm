{% extends "base.html" %}

{% block title %}Modo Offline - Chispart Mobile{% endblock %}

{% block content %}
<div class="offline-container">
    <!-- Offline Hero -->
    <div class="offline-hero">
        <div class="offline-icon">
            <div class="offline-symbol">üì°</div>
            <div class="offline-status">
                <span class="status-indicator offline"></span>
            </div>
        </div>
        
        <h1 class="offline-title">Modo Offline</h1>
        <p class="offline-subtitle">
            No hay conexi√≥n a internet disponible
        </p>
    </div>

    <!-- Status Information -->
    <div class="offline-status-section">
        <div class="status-card">
            <div class="status-header">
                <span class="status-icon">üåê</span>
                <h3>Estado de Conexi√≥n</h3>
            </div>
            <div class="status-content">
                <div class="connection-details">
                    <div class="detail-item">
                        <span class="detail-label">Estado:</span>
                        <span class="detail-value offline-text">Sin conexi√≥n</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">√öltima conexi√≥n:</span>
                        <span class="detail-value" id="last-online">Verificando...</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Modo:</span>
                        <span class="detail-value">Offline PWA</span>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="retry-connection">
                    üîÑ Reintentar Conexi√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Available Features -->
    <div class="offline-features-section">
        <h2 class="section-title">‚úÖ Funciones Disponibles</h2>
        
        <div class="features-grid">
            <div class="feature-card available">
                <div class="feature-icon">üí¨</div>
                <div class="feature-content">
                    <h3>Chat Offline</h3>
                    <p>Escribe mensajes que se enviar√°n cuando vuelvas a estar online</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge available">Disponible</span>
                </div>
            </div>
            
            <div class="feature-card available">
                <div class="feature-icon">üìù</div>
                <div class="feature-content">
                    <h3>Historial Local</h3>
                    <p>Accede a tus conversaciones guardadas localmente</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge available">Disponible</span>
                </div>
            </div>
            
            <div class="feature-card available">
                <div class="feature-icon">‚öôÔ∏è</div>
                <div class="feature-content">
                    <h3>Configuraci√≥n</h3>
                    <p>Ajusta preferencias y configuraciones locales</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge available">Disponible</span>
                </div>
            </div>
            
            <div class="feature-card available">
                <div class="feature-icon">üé®</div>
                <div class="feature-content">
                    <h3>Temas</h3>
                    <p>Cambia entre temas claro y oscuro</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge available">Disponible</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Limited Features -->
    <div class="offline-limited-section">
        <h2 class="section-title">‚ö†Ô∏è Funciones Limitadas</h2>
        
        <div class="features-grid">
            <div class="feature-card limited">
                <div class="feature-icon">ü§ñ</div>
                <div class="feature-content">
                    <h3>APIs de IA</h3>
                    <p>Requiere conexi√≥n para comunicarse con los servicios de IA</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge limited">Limitado</span>
                </div>
            </div>
            
            <div class="feature-card limited">
                <div class="feature-icon">üì∑</div>
                <div class="feature-content">
                    <h3>An√°lisis de Im√°genes</h3>
                    <p>Las im√°genes se guardar√°n para analizar cuando vuelvas online</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge limited">Limitado</span>
                </div>
            </div>
            
            <div class="feature-card limited">
                <div class="feature-icon">üîÑ</div>
                <div class="feature-content">
                    <h3>Sincronizaci√≥n</h3>
                    <p>Los datos se sincronizar√°n autom√°ticamente al reconectar</p>
                </div>
                <div class="feature-status">
                    <span class="status-badge limited">Limitado</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline Data -->
    <div class="offline-data-section">
        <h2 class="section-title">üíæ Datos Locales</h2>
        
        <div class="data-grid">
            <div class="data-card">
                <div class="data-header">
                    <span class="data-icon">üí¨</span>
                    <h3>Conversaciones</h3>
                </div>
                <div class="data-content">
                    <div class="data-value" id="offline-conversations">-</div>
                    <div class="data-label">Guardadas localmente</div>
                </div>
            </div>
            
            <div class="data-card">
                <div class="data-header">
                    <span class="data-icon">üì§</span>
                    <h3>Mensajes Pendientes</h3>
                </div>
                <div class="data-content">
                    <div class="data-value" id="pending-messages">-</div>
                    <div class="data-label">Para enviar</div>
                </div>
            </div>
            
            <div class="data-card">
                <div class="data-header">
                    <span class="data-icon">üíæ</span>
                    <h3>Almacenamiento</h3>
                </div>
                <div class="data-content">
                    <div class="data-value" id="storage-used">-</div>
                    <div class="data-label">KB utilizados</div>
                </div>
            </div>
            
            <div class="data-card">
                <div class="data-header">
                    <span class="data-icon">üïí</span>
                    <h3>√öltima Sync</h3>
                </div>
                <div class="data-content">
                    <div class="data-value" id="last-sync">-</div>
                    <div class="data-label">Sincronizaci√≥n</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="offline-actions-section">
        <h2 class="section-title">üöÄ Acciones Disponibles</h2>
        
        <div class="actions-grid">
            <a href="/chat" class="action-card primary">
                <div class="action-icon">üí¨</div>
                <div class="action-content">
                    <h3>Chat Offline</h3>
                    <p>Contin√∫a escribiendo mensajes</p>
                </div>
                <div class="action-arrow">‚Üí</div>
            </a>
            
            <a href="/config" class="action-card">
                <div class="action-icon">‚öôÔ∏è</div>
                <div class="action-content">
                    <h3>Configuraci√≥n</h3>
                    <p>Ajusta tus preferencias</p>
                </div>
                <div class="action-arrow">‚Üí</div>
            </a>
            
            <div class="action-card" id="view-history-card">
                <div class="action-icon">üìö</div>
                <div class="action-content">
                    <h3>Ver Historial</h3>
                    <p>Revisa conversaciones anteriores</p>
                </div>
                <div class="action-arrow">‚Üí</div>
            </div>
            
            <a href="/" class="action-card">
                <div class="action-icon">üè†</div>
                <div class="action-content">
                    <h3>Volver al Inicio</h3>
                    <p>Ir a la p√°gina principal</p>
                </div>
                <div class="action-arrow">‚Üí</div>
            </a>
        </div>
    </div>

    <!-- Tips for Offline Use -->
    <div class="offline-tips-section">
        <h2 class="section-title">üí° Consejos para Uso Offline</h2>
        
        <div class="tips-grid">
            <div class="tip-card">
                <div class="tip-icon">‚úçÔ∏è</div>
                <div class="tip-content">
                    <h4>Escribe Mensajes</h4>
                    <p>Puedes escribir mensajes que se enviar√°n autom√°ticamente cuando vuelvas a estar online.</p>
                </div>
            </div>
            
            <div class="tip-card">
                <div class="tip-icon">üì±</div>
                <div class="tip-content">
                    <h4>Funciona como App</h4>
                    <p>La aplicaci√≥n PWA funciona completamente offline una vez instalada.</p>
                </div>
            </div>
            
            <div class="tip-card">
                <div class="tip-icon">üîÑ</div>
                <div class="tip-content">
                    <h4>Sincronizaci√≥n Autom√°tica</h4>
                    <p>Todos los datos se sincronizar√°n autom√°ticamente al recuperar la conexi√≥n.</p>
                </div>
            </div>
            
            <div class="tip-card">
                <div class="tip-icon">üíæ</div>
                <div class="tip-content">
                    <h4>Datos Seguros</h4>
                    <p>Tus datos est√°n seguros y encriptados localmente mientras est√°s offline.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status Modal -->
<div class="modal-overlay" id="connection-modal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>üåê Estado de Conexi√≥n</h3>
            <button class="modal-close" id="close-connection-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="connection-test-results" id="connection-results">
                <p>Verificando conexi√≥n...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="close-modal">Cerrar</button>
            <button class="btn btn-primary" id="test-again">Probar de Nuevo</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos offline
    loadOfflineData();
    
    // Configurar eventos
    setupOfflineEvents();
    
    // Monitorear cambios de conexi√≥n
    monitorConnection();
    
    // Actualizar √∫ltima vez online
    updateLastOnlineTime();
    
    function loadOfflineData() {
        try {
            // Cargar conversaciones locales
            const history = JSON.parse(localStorage.getItem('chispart-chat-history') || '[]');
            document.getElementById('offline-conversations').textContent = history.length;
            
            // Cargar mensajes pendientes
            const pending = JSON.parse(localStorage.getItem('chispart-pending-messages') || '[]');
            document.getElementById('pending-messages').textContent = pending.length;
            
            // Calcular almacenamiento usado
            let storageSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('chispart')) {
                    storageSize += localStorage[key].length;
                }
            }
            document.getElementById('storage-used').textContent = Math.round(storageSize / 1024);
            
            // √öltima sincronizaci√≥n
            const lastSync = localStorage.getItem('chispart-last-sync');
            if (lastSync) {
                const syncDate = new Date(lastSync);
                document.getElementById('last-sync').textContent = syncDate.toLocaleString();
            } else {
                document.getElementById('last-sync').textContent = 'Nunca';
            }
            
        } catch (error) {
            console.error('Error loading offline data:', error);
        }
    }
    
    function setupOfflineEvents() {
        // Bot√≥n de reintentar conexi√≥n
        document.getElementById('retry-connection').addEventListener('click', testConnection);
        
        // Ver historial
        document.getElementById('view-history-card').addEventListener('click', () => {
            // Mostrar historial en modal o navegar al chat
            window.location.href = '/chat?view=history';
        });
        
        // Modal de conexi√≥n
        const connectionModal = document.getElementById('connection-modal');
        const closeModal = document.getElementById('close-connection-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const testAgain = document.getElementById('test-again');
        
        [closeModal, closeModalBtn].forEach(btn => {
            btn.addEventListener('click', () => {
                connectionModal.style.display = 'none';
            });
        });
        
        testAgain.addEventListener('click', testConnection);
    }
    
    function monitorConnection() {
        // Escuchar cambios de conexi√≥n
        window.addEventListener('online', () => {
            // Redirigir al inicio cuando vuelva la conexi√≥n
            setTimeout(() => {
                if (navigator.onLine) {
                    window.location.href = '/';
                }
            }, 1000);
        });
        
        window.addEventListener('offline', () => {
            updateLastOnlineTime();
        });
    }
    
    function updateLastOnlineTime() {
        const lastOnlineEl = document.getElementById('last-online');
        const lastOnline = localStorage.getItem('chispart-last-online');
        
        if (lastOnline) {
            const lastDate = new Date(lastOnline);
            const now = new Date();
            const diffMs = now - lastDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            let timeText;
            if (diffMins < 1) {
                timeText = 'Hace menos de un minuto';
            } else if (diffMins < 60) {
                timeText = `Hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
            } else if (diffHours < 24) {
                timeText = `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
            } else {
                timeText = `Hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
            }
            
            lastOnlineEl.textContent = timeText;
        } else {
            lastOnlineEl.textContent = 'Desconocido';
        }
        
        // Actualizar cada minuto
        setTimeout(updateLastOnlineTime, 60000);
    }
    
    async function testConnection() {
        const modal = document.getElementById('connection-modal');
        const results = document.getElementById('connection-results');
        const retryBtn = document.getElementById('retry-connection');
        
        // Mostrar modal
        modal.style.display = 'flex';
        results.innerHTML = '<p>üîÑ Verificando conexi√≥n...</p>';
        retryBtn.textContent = 'Verificando...';
        retryBtn.disabled = true;
        
        const tests = [
            { name: 'Navegador', test: () => Promise.resolve(navigator.onLine) },
            { name: 'DNS', test: () => fetch('https://1.1.1.1', { mode: 'no-cors', cache: 'no-cache' }) },
            { name: 'Internet', test: () => fetch('https://www.google.com', { mode: 'no-cors', cache: 'no-cache' }) },
            { name: 'API Blackbox', test: () => fetch('https://api.blackbox.ai', { mode: 'no-cors', cache: 'no-cache' }) }
        ];
        
        let resultsHtml = '<div class="connection-tests">';
        
        for (const test of tests) {
            try {
                const startTime = Date.now();
                await test.test();
                const endTime = Date.now();
                const latency = endTime - startTime;
                
                resultsHtml += `
                    <div class="test-result success">
                        <span class="test-name">${test.name}:</span>
                        <span class="test-status">‚úÖ OK (${latency}ms)</span>
                    </div>
                `;
            } catch (error) {
                resultsHtml += `
                    <div class="test-result error">
                        <span class="test-name">${test.name}:</span>
                        <span class="test-status">‚ùå Error</span>
                    </div>
                `;
            }
        }
        
        resultsHtml += '</div>';
        
        // Verificar si realmente hay conexi√≥n
        const hasConnection = navigator.onLine;
        if (hasConnection) {
            resultsHtml += '<div class="connection-summary success">üéâ ¬°Conexi√≥n restaurada! Redirigiendo...</div>';
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            resultsHtml += '<div class="connection-summary error">‚ùå Sin conexi√≥n a internet</div>';
        }
        
        results.innerHTML = resultsHtml;
        retryBtn.textContent = 'üîÑ Reintentar Conexi√≥n';
        retryBtn.disabled = false;
    }
    
    // Auto-refresh de datos cada 30 segundos
    setInterval(loadOfflineData, 30000);
});
</script>
{% endblock %}
