{% extends "base.html" %}

{% block title %}Chat - Chispart Mobile{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Header del chat con controles -->
    <div class="chat-header">
        <div class="chat-header-left">
            <h2>🤖 Chat con IA</h2>
            <div class="api-status">
                <span class="api-indicator" id="api-indicator">
                    <span class="status-dot"></span>
                    <span id="current-api">{{ config.default_api or 'blackbox' }}</span>
                </span>
            </div>
        </div>
        
        <div class="chat-header-right">
            <!-- Selector de API -->
            <div class="api-selector-container">
                <button class="api-selector active" data-api="blackbox" title="Blackbox AI">
                    <span class="api-icon">⚫</span>
                    <span class="api-name desktop-only">Blackbox</span>
                </button>
                <button class="api-selector" data-api="openai" title="OpenAI GPT">
                    <span class="api-icon">🤖</span>
                    <span class="api-name desktop-only">OpenAI</span>
                </button>
                <button class="api-selector" data-api="anthropic" title="Claude">
                    <span class="api-icon">🧠</span>
                    <span class="api-name desktop-only">Claude</span>
                </button>
                <button class="api-selector" data-api="groq" title="Groq">
                    <span class="api-icon">⚡</span>
                    <span class="api-name desktop-only">Groq</span>
                </button>
            </div>
            
            <!-- Controles del chat -->
            <div class="chat-controls">
                <button class="btn btn-sm btn-secondary" id="clear-chat" title="Limpiar chat">
                    🗑️
                </button>
                <button class="btn btn-sm btn-secondary toggle-theme" title="Cambiar tema">
                    🌓
                </button>
                <button class="btn btn-sm btn-primary desktop-only" id="install-btn" style="display: none;" title="Instalar app">
                    📱 Instalar
                </button>
            </div>
        </div>
    </div>

    <!-- Área de mensajes -->
    <div class="chat-messages" id="chat-messages">
        <div class="welcome-message">
            <div class="welcome-content">
                <h3>👋 ¡Bienvenido a Chispart Mobile!</h3>
                <p>Tu terminal universal de IA optimizado para dispositivos móviles.</p>
                <div class="welcome-features">
                    <div class="feature">
                        <span class="feature-icon">💬</span>
                        <span>Chat con múltiples APIs de IA</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">📷</span>
                        <span>Análisis de imágenes</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">📱</span>
                        <span>Optimizado para móviles</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">🔒</span>
                        <span>Almacenamiento seguro</span>
                    </div>
                </div>
                <p class="welcome-tip">
                    <strong>💡 Tip:</strong> Usa <kbd>Ctrl</kbd> + <kbd>Enter</kbd> para enviar mensajes rápidamente.
                </p>
            </div>
        </div>
    </div>

    <!-- Área de input -->
    <div class="chat-input-container">
        <!-- Selector de modelo -->
        <div class="model-selector-container mobile-only">
            <select id="model-selector" class="form-select">
                <option value="blackboxai/openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
                <option value="blackboxai/openai/gpt-4">GPT-4</option>
                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                <option value="llama2-70b-4096">Llama 2 70B</option>
                <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
            </select>
        </div>

        <!-- Formulario de chat -->
        <form id="chat-form" class="chat-form">
            <div class="input-group">
                <textarea 
                    id="message-input" 
                    class="message-input" 
                    placeholder="Escribe tu mensaje aquí... (Ctrl+Enter para enviar)"
                    rows="1"
                    maxlength="4000"
                ></textarea>
                
                <!-- Botones de acción -->
                <div class="input-actions">
                    <button type="button" class="action-btn" id="image-btn" title="Subir imagen">
                        📷
                    </button>
                    <button type="button" class="action-btn" id="voice-btn" title="Mensaje de voz" style="display: none;">
                        🎤
                    </button>
                    <button type="submit" class="send-button" id="send-button" title="Enviar mensaje">
                        ➤
                    </button>
                </div>
            </div>
        </form>

        <!-- Upload de imagen (oculto) -->
        <form id="image-form" class="image-form" style="display: none;">
            <div class="image-upload-container">
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <div class="image-preview" id="image-preview" style="display: none;">
                    <img id="preview-img" alt="Preview">
                    <button type="button" class="remove-image" id="remove-image">✕</button>
                </div>
                <div class="image-prompt-container">
                    <input 
                        type="text" 
                        id="image-prompt" 
                        class="form-input" 
                        placeholder="¿Qué quieres saber sobre esta imagen?"
                        maxlength="500"
                    >
                    <div class="image-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-image">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Analizar Imagen</button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Información del archivo -->
        <div class="file-info" id="file-info" style="display: none;"></div>
        
        <!-- Contador de caracteres -->
        <div class="char-counter" id="char-counter">0/4000</div>
    </div>
</div>

<!-- Estado de conexión -->
<div class="connection-status" id="connection-status" style="display: none;"></div>

<!-- Modal de configuración rápida -->
<div class="modal-overlay" id="api-setup-modal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>🔑 Configurar API Key</h3>
            <button class="modal-close" id="close-setup-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Para usar <span id="setup-api-name"></span>, necesitas configurar tu API key.</p>
            <div class="form-group">
                <label class="form-label">API Key:</label>
                <input type="password" id="setup-api-key" class="form-input" placeholder="Ingresa tu API key">
                <div class="form-help">Tu API key se almacena de forma segura y encriptada.</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-setup">Cancelar</button>
            <button class="btn btn-primary" id="save-setup">Guardar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Configuración inicial del chat
document.addEventListener('DOMContentLoaded', function() {
    // Auto-resize del textarea
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            
            // Actualizar contador de caracteres
            const counter = document.getElementById('char-counter');
            if (counter) {
                const count = this.value.length;
                counter.textContent = `${count}/4000`;
                counter.className = `char-counter ${count > 3800 ? 'warning' : ''}`;
            }
        });
        
        // Envío con Ctrl+Enter
        messageInput.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });
    }
    
    // Manejo de upload de imagen
    const imageBtn = document.getElementById('image-btn');
    const imageInput = document.getElementById('image-input');
    const imageForm = document.getElementById('image-form');
    const chatForm = document.getElementById('chat-form');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    
    if (imageBtn && imageInput) {
        imageBtn.addEventListener('click', () => {
            imageInput.click();
        });
        
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                    imageForm.style.display = 'block';
                    chatForm.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Cancelar imagen
    const cancelImage = document.getElementById('cancel-image');
    const removeImage = document.getElementById('remove-image');
    
    [cancelImage, removeImage].forEach(btn => {
        if (btn) {
            btn.addEventListener('click', () => {
                imageInput.value = '';
                imagePreview.style.display = 'none';
                imageForm.style.display = 'none';
                chatForm.style.display = 'block';
                document.getElementById('image-prompt').value = '';
            });
        }
    });
    
    // Limpiar chat
    const clearChat = document.getElementById('clear-chat');
    if (clearChat) {
        clearChat.addEventListener('click', () => {
            if (window.chispartMobile) {
                window.chispartMobile.clearChat();
            }
        });
    }
    
    // Modal de configuración
    const setupModal = document.getElementById('api-setup-modal');
    const closeSetupModal = document.getElementById('close-setup-modal');
    const cancelSetup = document.getElementById('cancel-setup');
    const saveSetup = document.getElementById('save-setup');
    
    [closeSetupModal, cancelSetup].forEach(btn => {
        if (btn) {
            btn.addEventListener('click', () => {
                setupModal.style.display = 'none';
            });
        }
    });
    
    if (saveSetup) {
        saveSetup.addEventListener('click', async () => {
            const apiName = document.getElementById('setup-api-name').textContent;
            const apiKey = document.getElementById('setup-api-key').value.trim();
            
            if (!apiKey) {
                alert('Por favor ingresa una API key válida');
                return;
            }
            
            try {
                const response = await fetch('/api/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: apiName, api_key: apiKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setupModal.style.display = 'none';
                    document.getElementById('setup-api-key').value = '';
                    
                    if (window.ChispartUtils) {
                        window.ChispartUtils.UI.showToast('API key configurada correctamente', 'success');
                    }
                } else {
                    alert('Error configurando API key: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    }
    
    // Mostrar modal de configuración cuando sea necesario
    window.showAPISetupModal = function(apiName) {
        document.getElementById('setup-api-name').textContent = apiName;
        setupModal.style.display = 'flex';
        document.getElementById('setup-api-key').focus();
    };
});
</script>
{% endblock %}
